# docker-compose.yml - Production-ready setup for micro-blog
services:
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    image: frontend:latest
    ports:
      - "80:80"
    restart: unless-stopped
    depends_on:
      - backend
    networks:
      - micro-blog-network

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    image: backend:latest
    environment:
      - NODE_ENV=production
      - PORT=5000
    ports:
      - "5000:5000"
    restart: unless-stopped
    # Note: don't make backend depend on frontend. The frontend should start
    # after the backend so it can proxy or call API endpoints. Use
    # `depends_on` on the frontend side (above) instead.
    networks:
      - micro-blog-network
    # Use a node-based healthcheck so we don't depend on wget/curl being
    # present in the image. Adjust path if your app exposes a different
    # health endpoint (e.g., /health or /api/health).
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get({host:'127.0.0.1',port:5000,path:'/api/posts'},res=>{process.exit(res.statusCode===200?0:1)}).on('error',()=>process.exit(1))"]
      interval: 10s
      timeout: 5s
      retries: 3

networks:
  micro-blog-network:
    name: micro-blog-network
